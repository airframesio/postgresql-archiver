let allData=[],currentData={},currentSort={column:"partition",direction:"asc"},ws=null,wsReconnectInterval=null,lastTaskState=null;function escapeHTML(t){if(null==t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}function escapeHTMLAttr(t){return null==t?"":String(t).replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function announceToScreenReader(t){let e=document.getElementById("sr-announcements");e||(e=document.createElement("div"),e.id="sr-announcements",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",document.body.appendChild(e)),e.textContent=t,setTimeout(()=>{e.textContent=""},1e3)}function showAlert(t,e,n="",a=5e3){let o=document.getElementById("alert-container");o||(o=document.createElement("div"),o.id="alert-container",document.body.appendChild(o));const s=document.createElement("div");s.className=`alert alert-${t}`,s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive");s.innerHTML=`\n        <div class="alert-icon">${{success:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',error:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',warning:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'}[t]}</div>\n        <div class="alert-content">\n            <div class="alert-title">${escapeHTML(e)}</div>\n            ${n?`<div class="alert-description">${escapeHTML(n)}</div>`:""}\n        </div>\n        <button class="alert-close" aria-label="Close alert">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n        </button>\n    `,o.appendChild(s),s.querySelector(".alert-close").addEventListener("click",()=>{s.style.opacity="0",s.style.transform="translateY(-10px)",setTimeout(()=>s.remove(),300)}),a>0&&setTimeout(()=>{s.parentElement&&(s.style.opacity="0",s.style.transform="translateY(-10px)",setTimeout(()=>{s.parentElement&&s.remove()},300))},a),announceToScreenReader(`${t}: ${e}${n?". "+n:""}`)}function showLoadingSkeleton(){const t=document.getElementById("table-body"),e=Array(5).fill(0).map(()=>'\n        <tr>\n            <td><div class="skeleton skeleton-text" style="width: 80%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 60%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 70%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 70%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 50%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 90%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 60%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 55%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 40%;"></div></td>\n        </tr>\n    ').join("");t.innerHTML=e}function formatBytes(t){if(!t||0===t)return"—";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(2))+" "+["B","KB","MB","GB","TB"][e]}function calculateRatio(t,e){if(!t||!e)return"—";return(t/e).toFixed(1)+"x"}function calculateAge(t){if(!t)return{text:"—",class:"old"};const e=new Date(t);if(isNaN(e.getTime())||0===e.getTime())return{text:"—",class:"old"};const n=new Date;if((n-e)/31536e6>10)return{text:"—",class:"old"};const a=Math.floor((n-e)/36e5);if(a<1){return{text:Math.floor((n-e)/6e4)+"m",class:"fresh"}}if(a<6)return{text:a+"h",class:"fresh"};if(a<24)return{text:a+"h",class:"recent"};return{text:Math.floor(a/24)+"d",class:"old"}}function getRowKey(t){return t.table+"|"+t.partition}function connectWebSocket(){const t=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/ws";ws=new WebSocket(t),ws.onopen=function(){console.log("WebSocket connected"),document.getElementById("status").classList.add("connected"),document.getElementById("status").classList.remove("disconnected"),document.getElementById("status-text").textContent="Connected to live updates",wsReconnectInterval&&(clearTimeout(wsReconnectInterval),wsReconnectInterval=null)},ws.onmessage=function(t){try{const e=JSON.parse(t.data);"cache"===e.type?handleCacheData(e.data):"status"===e.type&&updateTaskPanel(e.data)}catch(t){console.error("Error handling WebSocket message:",t)}},ws.onerror=function(t){console.error("WebSocket error:",t)},ws.onclose=function(t){if(console.log("WebSocket disconnected",t),document.getElementById("status").classList.remove("connected"),document.getElementById("status").classList.add("disconnected"),t.wasClean?document.getElementById("status-text").textContent="Connection closed - reconnecting...":document.getElementById("status-text").textContent="Connection lost - attempting to reconnect...",!wsReconnectInterval){let t=0,e=1e3;const n=()=>{t++;if(t>30)return wsReconnectInterval=null,void(document.getElementById("status-text").textContent="Connection failed - please refresh the page");console.log("Reconnect attempt "+t+"/30 (delay: "+e+"ms)"),document.getElementById("status-text").textContent="Reconnecting ("+t+"/30)...",connectWebSocket(),e=Math.min(2*e,3e4),wsReconnectInterval=setTimeout(n,e)};wsReconnectInterval=setTimeout(n,e)}}}function updateTaskPanel(t){const e=document.getElementById("task-panel");if(t.archiverRunning){if(e.classList.remove("idle"),document.getElementById("task-title").textContent="Archiver Running",document.getElementById("task-pid").textContent="PID: "+t.pid,t.currentTask){lastTaskState=t.currentTask;const e=t.currentTask,n=e.current_step||e.current_task||"Processing...",a=document.getElementById("task-status-text");if(e.current_partition){a.textContent="",a.appendChild(document.createTextNode("Table: "));const t=document.createElement("a");t.href="#",t.className="partition-link",t.setAttribute("data-partition",e.current_partition),t.textContent=e.current_partition,a.appendChild(t),a.appendChild(document.createTextNode(" - "+n))}else a.textContent=n}else if(lastTaskState){const t=lastTaskState,e=t.current_step||t.current_task||"Processing...",n=document.getElementById("task-status-text");if(t.current_partition){n.textContent="",n.appendChild(document.createTextNode("Table: "));const a=document.createElement("a");a.href="#",a.className="partition-link",a.setAttribute("data-partition",t.current_partition),a.textContent=t.current_partition,n.appendChild(a),n.appendChild(document.createTextNode(" - "+e))}else n.textContent=e}else document.getElementById("task-status-text").textContent="Starting...";const n=t.currentTask||lastTaskState;if(n&&n.total_items>0){const t=document.getElementById("task-progress-bar"),e=document.getElementById("task-progress-fill");t.style.display="block";const a=n.completed_items/n.total_items*100;e.style.width=a+"%",t.setAttribute("aria-valuenow",Math.round(a)),document.getElementById("task-stats").textContent=n.completed_items+"/"+n.total_items+" partitions ("+Math.round(a)+"%)"}else document.getElementById("task-progress-bar").style.display="none",document.getElementById("task-stats").textContent="";if(n&&n.start_time){const t=new Date(n.start_time),e=Math.floor((new Date-t)/1e3),a=Math.floor(e/60),o=e%60;document.getElementById("task-time").textContent=a+"m "+o+"s"}}else e.classList.add("idle"),document.getElementById("task-title").textContent="Archiver Idle",document.getElementById("task-pid").textContent="",document.getElementById("task-status-text").textContent="No active archiving process",document.getElementById("task-progress-bar").style.display="none",document.getElementById("task-stats").textContent="",document.getElementById("task-time").textContent="",lastTaskState=null}function handleCacheData(t){const e=[],n=new Set;t.tables.forEach(t=>{n.add(t.tableName),t.entries.forEach(t=>{e.push(t)})}),updateTableFilter(Array.from(n)),allData=e,sortData(currentSort.column,!1),updateStats(),updateTable(),document.getElementById("last-update").textContent="Last updated: "+(new Date).toLocaleTimeString()}async function fetchInitialData(){try{const t=await fetch("/api/cache");if(t.ok){handleCacheData(await t.json())}const e=await fetch("/api/status");if(e.ok){updateTaskPanel(await e.json())}}catch(t){console.error("Error fetching initial data:",t)}}function updateTableFilter(t){const e=document.getElementById("table-filter"),n=e.value;e.innerHTML='<option value="">All Tables</option>',t.sort().forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}),n&&t.includes(n)&&(e.value=n)}function updateStats(){const t=allData.length,e=allData.filter(t=>t.fileSize>0).length,n=allData.filter(t=>t.lastError).length,a=allData.reduce((t,e)=>t+(e.fileSize||0),0),o=allData.reduce((t,e)=>t+(e.uncompressedSize||0),0),s=allData.reduce((t,e)=>t+(e.rowCount||0),0),l=calculateRatio(o,a),r=document.getElementById("stats-grid"),c=r.querySelector(".stat-card:nth-child(1) .value")?.textContent,i=r.querySelector(".stat-card:nth-child(2) .value")?.textContent,d=r.querySelector(".stat-card:nth-child(3) .value")?.textContent,u=r.querySelector(".stat-card:nth-child(4) .value")?.textContent;r.innerHTML='<div class="stat-card"><div class="label">Total Partitions</div><div class="value">'+t.toLocaleString()+'</div><div class="detail">'+e+" cached, "+n+' errors</div></div><div class="stat-card"><div class="label">Total Size</div><div class="value">'+formatBytes(a)+'</div><div class="detail">Uncompressed: '+formatBytes(o)+'</div></div><div class="stat-card"><div class="label">Compression</div><div class="value">'+l+'</div><div class="detail">Average ratio</div></div><div class="stat-card"><div class="label">Total Rows</div><div class="value">'+s.toLocaleString()+'</div><div class="detail">Across all partitions</div></div>';const m=t.toLocaleString(),p=formatBytes(a),h=l,y=s.toLocaleString();setTimeout(()=>{c&&c!==m&&animateCell(r.querySelector(".stat-card:nth-child(1) .value")),i&&i!==p&&animateCell(r.querySelector(".stat-card:nth-child(2) .value")),d&&d!==h&&animateCell(r.querySelector(".stat-card:nth-child(3) .value")),u&&u!==y&&animateCell(r.querySelector(".stat-card:nth-child(4) .value"))},10)}function sortData(t,e=!0){e&&currentSort.column===t?currentSort.direction="asc"===currentSort.direction?"desc":"asc":e&&(currentSort.column=t,currentSort.direction="asc"),allData.sort((e,n)=>{let a=e[t],o=n[t];return"fileTime"===t||"countTime"===t||"errorTime"===t?(a=a?new Date(a).getTime():0,o=o?new Date(o).getTime():0):"string"==typeof a?(a=(a||"").toLowerCase(),o=(o||"").toLowerCase()):(a=a||0,o=o||0),a<o?"asc"===currentSort.direction?-1:1:a>o?"asc"===currentSort.direction?1:-1:0}),updateTable(),updateSortIndicators()}function updateSortIndicators(){document.querySelectorAll("thead th.sortable").forEach(t=>{t.className="sortable",t.dataset.column===currentSort.column?(t.className="sortable sorted-"+currentSort.direction,t.setAttribute("aria-sort","asc"===currentSort.direction?"ascending":"descending"),announceToScreenReader("Column "+t.textContent.trim()+" sorted "+("asc"===currentSort.direction?"ascending":"descending"))):t.setAttribute("aria-sort","none")})}function updateTable(){const t=document.getElementById("search-box").value,e=document.getElementById("table-filter").value;let n=allData;if(e&&(n=n.filter(t=>t.table===e)),t){const e=t.toLowerCase();n=n.filter(t=>t.partition.toLowerCase().includes(e)||t.table.toLowerCase().includes(e))}const a=document.getElementById("table-body");if(0===n.length&&(t||e))return a.innerHTML='<tr><td colspan="9" style="text-align: center; padding: 60px 20px;"><div class="empty-state"><h3>No Results Found</h3><p>No cache entries match your filters. Try adjusting your search or filter.</p><button class="clear-search-btn" id="clear-filters-btn">Clear Filters</button></div></td></tr>',void document.getElementById("clear-filters-btn")?.addEventListener("click",()=>{document.getElementById("search-box").value="",document.getElementById("table-filter").value="",updateTable()});const o={};a.querySelectorAll("tr").forEach(t=>{o[t.dataset.key]=t}),a.innerHTML="",n.forEach(t=>{const e=getRowKey(t);let n=o[e];n?updateRow(n,t):n=createRow(t),a.appendChild(n)})}function createRow(t){const e=document.createElement("tr");return e.dataset.key=getRowKey(t),e.setAttribute("role","row"),e.setAttribute("aria-label","Partition "+t.partition+" in table "+t.table),updateRow(e,t),e}function updateRow(t,e){const n=calculateAge(e.fileTime||e.countTime),a=e.fileSize>0,o=!!e.lastError,s=e.s3Uploaded,l=calculateRatio(e.uncompressedSize,e.fileSize);let r="";r=o?'<span class="status-badge error">Error</span>':s?'<span class="status-badge uploaded">In S3</span>':a?'<span class="status-badge cached">Processed</span>':'<span class="status-badge no-file">Count Only</span>';const c=t.querySelector("td:nth-child(2)")?.textContent,i=t.querySelector("td:nth-child(3)")?.textContent,d=t.querySelector("td:nth-child(4)")?.textContent,u=t.querySelector("td:nth-child(8) .status-badge")?.textContent;t.innerHTML='<td><div class="partition-name">'+escapeHTML(e.partition)+'</div><div class="table-name">'+escapeHTML(e.table)+'</div></td><td class="size">'+(e.rowCount?e.rowCount.toLocaleString():"—")+'</td><td class="size">'+formatBytes(e.uncompressedSize)+'</td><td class="size">'+formatBytes(e.fileSize)+'</td><td class="ratio">'+l+'</td><td class="hash">'+(e.fileMD5?'<span title="'+escapeHTMLAttr(e.fileMD5)+'">'+escapeHTML(e.fileMD5.substring(0,12))+"...</span>":"—")+'</td><td><span class="age '+n.class+'">'+n.text+"</span></td><td>"+r+"</td><td>"+(o?'<div class="error-text" title="'+escapeHTMLAttr(e.lastError)+'">'+escapeHTML(e.lastError)+"</div>":"—")+"</td>";const m=e.rowCount?e.rowCount.toLocaleString():"—",p=formatBytes(e.uncompressedSize),h=formatBytes(e.fileSize),y=t.querySelector("td:nth-child(8) .status-badge")?.textContent;setTimeout(()=>{c!==m&&c&&animateCell(t.querySelector("td:nth-child(2)")),i!==p&&i&&animateCell(t.querySelector("td:nth-child(3)")),d!==h&&d&&animateCell(t.querySelector("td:nth-child(4)")),u!==y&&u&&animateCell(t.querySelector("td:nth-child(8)"))},10)}function animateCell(t){t&&(t.classList.remove("updated"),t.offsetWidth,t.classList.add("updated"),setTimeout(()=>t.classList.remove("updated"),800))}const searchBox=document.getElementById("search-box"),clearBtn=document.getElementById("clear-search");searchBox.addEventListener("input",t=>{const e=t.target.value;clearBtn.style.display=e?"flex":"none",updateTable()}),clearBtn.addEventListener("click",()=>{searchBox.value="",clearBtn.style.display="none",updateTable(),searchBox.focus(),announceToScreenReader("Search cleared")}),document.getElementById("table-filter").addEventListener("change",updateTable),document.addEventListener("click",t=>{const e=t.target.closest("th.sortable");e&&sortData(e.dataset.column)}),document.addEventListener("keydown",t=>{const e=t.target.closest("th.sortable");!e||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),sortData(e.dataset.column))}),document.addEventListener("click",t=>{const e=t.target.closest(".partition-link");if(e){t.preventDefault();const n=e.dataset.partition;n&&scrollToPartition(n)}}),fetchInitialData(),updateSortIndicators(),connectWebSocket(),window.scrollToPartition=function(t){setTimeout(()=>{const e=document.querySelectorAll("#table-body tr");for(const n of e){const e=n.querySelector("td:first-child .partition-name");if(e&&e.textContent.trim()===t){const t=n.style.background;n.style.background="#fffacd",n.scrollIntoView({behavior:"smooth",block:"center"});const e=document.querySelector(".table-wrapper");if(e){const t=n.offsetTop,a=n.offsetHeight,o=e.scrollTop,s=e.offsetHeight;(t<o||t+a>o+s)&&(e.scrollTop=t-s/2+a/2)}setTimeout(()=>{n.style.background=t||""},2e3);break}}},100)},window.addEventListener("beforeunload",()=>{ws&&ws.close(),wsReconnectInterval&&clearTimeout(wsReconnectInterval)});