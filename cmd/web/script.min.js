let allData=[],currentData={},currentSort={column:"partition",direction:"asc"},ws=null,wsReconnectInterval=null,wsReconnectAttempts=0,wsReconnectDelay=1e3,lastTaskState=null,archiverRunning=!1,updateDebounceTimer=null,pendingCacheData=null,lastStatsValues=null,lastSummaryValues=null,currentTaskInfo=null,archiverStartTime=null,currentPartition=null,statsMode="current",logsWebSocket=null,logsPaused=!1,logsBuffer=[],maxLogEntries=1e4,followActive=!1,followInterval=null;function getOutputFormat(t){if(!t)return"—";const e=t.split("/").pop();if(!e)return"—";const n=e.split(".");if(n.length<2)return"—";const a=["jsonl","csv","parquet","json"],s=n[n.length-1].toLowerCase();if(["zst","lz4","gz","bz2","xz","zstd"].includes(s)&&n.length>=3){const t=n[n.length-2].toLowerCase();if(a.includes(t))return t.toUpperCase()}return a.includes(s)?s.toUpperCase():n[n.length-1].toUpperCase()}function getCompressionType(t){if(!t)return null;const e=t.split("/").pop();if(!e)return null;const n=e.split(".");if(n.length<2)return null;const a=n[n.length-1].toLowerCase(),s={zst:"ZSTD",zstd:"ZSTD",lz4:"LZ4",gz:"GZIP",gzip:"GZIP",bz2:"BZIP2",xz:"XZ"};return s[a]?s[a]:null}function getS3Bucket(t){if(!t)return null;if(t.startsWith("s3://")){return t.substring(5).split("/")[0]||null}return null}function escapeHTML(t){if(null==t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}function escapeHTMLAttr(t){return null==t?"":String(t).replace(/&/g,"&amp;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function announceToScreenReader(t){let e=document.getElementById("sr-announcements");e||(e=document.createElement("div"),e.id="sr-announcements",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",document.body.appendChild(e)),e.textContent=t,setTimeout(()=>{e.textContent=""},1e3)}function showAlert(t,e,n="",a=5e3){let s=document.getElementById("alert-container");s||(s=document.createElement("div"),s.id="alert-container",document.body.appendChild(s));const o=document.createElement("div");o.className=`alert alert-${t}`,o.setAttribute("role","alert"),o.setAttribute("aria-live","assertive");o.innerHTML=`\n        <div class="alert-icon">${{success:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',error:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',warning:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'}[t]}</div>\n        <div class="alert-content">\n            <div class="alert-title">${escapeHTML(e)}</div>\n            ${n?`<div class="alert-description">${escapeHTML(n)}</div>`:""}\n        </div>\n        <button class="alert-close" aria-label="Close alert">\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n            </svg>\n        </button>\n    `,s.appendChild(o),o.querySelector(".alert-close").addEventListener("click",()=>{o.style.opacity="0",o.style.transform="translateY(-10px)",setTimeout(()=>o.remove(),300)}),a>0&&setTimeout(()=>{o.parentElement&&(o.style.opacity="0",o.style.transform="translateY(-10px)",setTimeout(()=>{o.parentElement&&o.remove()},300))},a),announceToScreenReader(`${t}: ${e}${n?". "+n:""}`)}function showLoadingSkeleton(){const t=document.getElementById("table-body"),e=Array(5).fill(0).map(()=>'\n        <tr>\n            <td><div class="skeleton skeleton-text" style="width: 80%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 60%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 70%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 70%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 50%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 90%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 60%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 55%;"></div></td>\n            <td><div class="skeleton skeleton-text" style="width: 40%;"></div></td>\n        </tr>\n    ').join("");t.innerHTML=e}function formatBytes(t){if(!t||0===t)return"—";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(2))+" "+["B","KB","MB","GB","TB"][e]}function formatNumber(t){return t<1e3?t.toString():t.toLocaleString()}function calculateRatio(t,e){if(!t||!e)return"—";return(t/e).toFixed(1)+"x"}function formatDuration(t){if(!t||t<0)return"0s";const e=Math.floor(t/86400),n=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),s=Math.floor(t%60);return e>0?e+"d "+n+"h":n>0?n+"h "+a+"m":a>0?a+"m "+s+"s":s+"s"}function calculateAge(t){if(!t)return{text:"—",class:"old"};const e=new Date(t);if(isNaN(e.getTime())||0===e.getTime())return{text:"—",class:"old"};const n=new Date;if((n-e)/31536e6>10)return{text:"—",class:"old"};const a=Math.floor((n-e)/36e5);if(a<1){return{text:Math.floor((n-e)/6e4)+"m",class:"fresh"}}if(a<6)return{text:a+"h",class:"fresh"};if(a<24)return{text:a+"h",class:"recent"};return{text:Math.floor(a/24)+"d",class:"old"}}function calculateCompletionAge(t){const e=t.s3UploadTime&&"0001-01-01T00:00:00Z"!==t.s3UploadTime?t.s3UploadTime:t.fileTime&&"0001-01-01T00:00:00Z"!==t.fileTime?t.fileTime:null;return calculateAge(e||t.countTime)}function calculateProcessingTime(t){let e=null;if(t.processStartTime&&"0001-01-01T00:00:00Z"!==t.processStartTime?e=new Date(t.processStartTime):t.countTime&&"0001-01-01T00:00:00Z"!==t.countTime&&(e=new Date(t.countTime)),!e||isNaN(e.getTime())||0===e.getTime())return"—";let n=null;if(t.s3Uploaded&&t.s3UploadTime&&"0001-01-01T00:00:00Z"!==t.s3UploadTime?n=new Date(t.s3UploadTime):t.fileTime&&"0001-01-01T00:00:00Z"!==t.fileTime&&(n=new Date(t.fileTime)),!n||isNaN(n.getTime())||0===n.getTime())return"—";const a=n-e;if(a<0)return"—";const s=Math.floor(a/1e3),o=Math.floor(s/60),l=Math.floor(o/60),r=Math.floor(l/24);return r>0?r+"d "+l%24+"h":l>0?l+"h "+o%60+"m":o>0?o+"m "+s%60+"s":s+"s"}function getProcessingTimeSeconds(t){let e=null;if(t.processStartTime&&"0001-01-01T00:00:00Z"!==t.processStartTime?e=new Date(t.processStartTime):t.countTime&&"0001-01-01T00:00:00Z"!==t.countTime&&(e=new Date(t.countTime)),!e||isNaN(e.getTime())||0===e.getTime())return 0;let n=null;if(t.s3Uploaded&&t.s3UploadTime&&"0001-01-01T00:00:00Z"!==t.s3UploadTime?n=new Date(t.s3UploadTime):t.fileTime&&"0001-01-01T00:00:00Z"!==t.fileTime&&(n=new Date(t.fileTime)),!n||isNaN(n.getTime())||0===n.getTime())return 0;const a=n-e;return a<0?0:Math.floor(a/1e3)}function getRowKey(t){return t.table+"|"+t.partition}function scheduleReconnection(){wsReconnectInterval&&(clearTimeout(wsReconnectInterval),wsReconnectInterval=null),wsReconnectAttempts++;wsReconnectAttempts>30?document.getElementById("status-text").textContent="Connection failed - please refresh the page":(console.log("Reconnect attempt "+wsReconnectAttempts+"/30 (delay: "+wsReconnectDelay+"ms)"),document.getElementById("status-text").textContent="Reconnecting ("+wsReconnectAttempts+"/30)...",wsReconnectInterval=setTimeout(function(){wsReconnectInterval=null,connectWebSocket(),wsReconnectDelay=Math.min(2*wsReconnectDelay,3e4)},wsReconnectDelay))}function connectWebSocket(){wsReconnectInterval&&(clearTimeout(wsReconnectInterval),wsReconnectInterval=null),ws&&(ws.onopen=null,ws.onclose=null,ws.onerror=null,ws.onmessage=null,ws.close(),ws=null);const t=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/ws";ws=new WebSocket(t),ws.onopen=function(){console.log("WebSocket connected"),document.getElementById("status").classList.add("connected"),document.getElementById("status").classList.remove("disconnected"),document.getElementById("status-text").textContent="Connected to live updates",wsReconnectAttempts=0,wsReconnectDelay=1e3,wsReconnectInterval&&(clearTimeout(wsReconnectInterval),wsReconnectInterval=null)},ws.onmessage=function(t){try{const e=JSON.parse(t.data);"cache"===e.type?handleCacheData(e.data):"status"===e.type&&updateTaskPanel(e.data)}catch(t){console.error("Error handling WebSocket message:",t)}},ws.onerror=function(t){console.error("WebSocket error:",t)},ws.onclose=function(t){console.log("WebSocket disconnected",t),document.getElementById("status").classList.remove("connected"),document.getElementById("status").classList.add("disconnected"),t.wasClean?document.getElementById("status-text").textContent="Connection closed - reconnecting...":document.getElementById("status-text").textContent="Connection lost - attempting to reconnect...",scheduleReconnection()}}function updateTaskPanel(t){const e=document.getElementById("task-panel");if(archiverRunning=t.archiverRunning||!1,t.version){if(document.getElementById("version-info").textContent="v"+t.version,t.updateAvailable&&t.latestVersion){const e=document.getElementById("update-banner");document.getElementById("update-message").innerHTML="Update available: v"+t.version+" → v"+t.latestVersion+' <a href="'+(t.releaseUrl||"https://github.com/airframesio/postgresql-archiver/releases")+'" target="_blank">Download</a>',e.style.display="flex"}}if(t.archiverRunning){if(e.classList.remove("idle"),document.getElementById("task-title").textContent="Archiver Running",document.getElementById("task-pid").textContent="PID: "+t.pid,t.currentTask){lastTaskState=t.currentTask,currentTaskInfo=t.currentTask;const e=t.currentTask.current_partition||null,n=e!==currentPartition;currentPartition=e,followActive&&n&&e&&scrollToCurrentPartition(),!archiverStartTime&&t.currentTask.start_time&&(archiverStartTime=new Date(t.currentTask.start_time));const a=t.currentTask,s=a.current_step||a.current_task||"Processing...",o=document.getElementById("task-status-text");if(a.current_partition){o.textContent="",o.appendChild(document.createTextNode("Table: "));const t=document.createElement("a");t.href="#",t.className="partition-link",t.setAttribute("data-partition",a.current_partition),t.textContent=a.current_partition,o.appendChild(t),o.appendChild(document.createTextNode(" - "+s))}else o.textContent=s;n&&updateTable(),updateTable(),forceStatsUpdate()}else if(lastTaskState){const t=lastTaskState,e=t.current_step||t.current_task||"Processing...",n=document.getElementById("task-status-text");if(t.current_partition){n.textContent="",n.appendChild(document.createTextNode("Table: "));const a=document.createElement("a");a.href="#",a.className="partition-link",a.setAttribute("data-partition",t.current_partition),a.textContent=t.current_partition,n.appendChild(a),n.appendChild(document.createTextNode(" - "+e))}else n.textContent=e}else document.getElementById("task-status-text").textContent="Starting...";const n=t.currentTask||lastTaskState;if(n&&n.total_items>0){const e=document.getElementById("task-progress-bar"),a=document.getElementById("task-progress-fill");e.style.display="block";const s=n.completed_items/n.total_items*100;a.style.width=s+"%",e.setAttribute("aria-valuenow",Math.round(s));let o=n.completed_items+"/"+n.total_items+" partitions ("+Math.round(s)+"%)";n.total_partitions>0&&(o=n.total_partitions+" total | "+o),n.partitions_counted>0&&n.partitions_counted!==n.total_partitions&&(o+=" | "+n.partitions_counted+" counted"),t.isSlicing&&t.totalSlices>0&&(o+=" | "+(t.currentSliceIndex+1)+"/"+t.totalSlices+" slices"),n.slices_processed>0&&(o+=" | "+n.slices_processed+" slices processed"),document.getElementById("task-stats").textContent=o}else document.getElementById("task-progress-bar").style.display="none",document.getElementById("task-stats").textContent="";if(n&&n.start_time){const t=new Date(n.start_time),e=Math.floor((new Date-t)/1e3),a=Math.floor(e/60),s=e%60;document.getElementById("task-time").textContent=a+"m "+s+"s"}if(t.isSlicing&&t.totalSlices>0){const e=document.getElementById("task-slice-progress-bar"),n=document.getElementById("task-slice-progress-fill");e.style.display="block";const a=(t.currentSliceIndex+1)/t.totalSlices*100;n.style.width=a+"%",e.setAttribute("aria-valuenow",Math.round(a))}else document.getElementById("task-slice-progress-bar").style.display="none"}else e.classList.add("idle"),document.getElementById("task-title").textContent="Archiver Idle",document.getElementById("task-pid").textContent="",document.getElementById("task-status-text").textContent="No active archiving process",document.getElementById("task-progress-bar").style.display="none",document.getElementById("task-slice-progress-bar").style.display="none",document.getElementById("task-stats").textContent="",document.getElementById("task-time").textContent="",currentTaskInfo=null,archiverStartTime=null,currentPartition=null,lastTaskState=null,followActive&&toggleFollow(),updateStats();t.archiverRunning||(updateDebounceTimer&&clearTimeout(updateDebounceTimer),updateDebounceTimer=setTimeout(()=>{updateCompletionSummary()},250))}function handleCacheData(t){pendingCacheData=t,updateDebounceTimer&&clearTimeout(updateDebounceTimer),updateDebounceTimer=setTimeout(()=>{if(!pendingCacheData)return;const t=[],e=new Set;pendingCacheData.tables.forEach(n=>{e.add(n.tableName),n.entries.forEach(e=>{t.push(e)})}),updateTableFilter(Array.from(e)),allData=t,sortData(currentSort.column,!1),updateStats(),updateTable(),document.getElementById("last-update").textContent="Last updated: "+(new Date).toLocaleTimeString(),updateCompletionSummary(),pendingCacheData=null},250)}function forceStatsUpdate(){lastStatsValues=null,updateStats()}async function fetchInitialData(){try{const t=await fetch("/api/cache");if(t.ok){const e=await t.json();console.log("Fetched cache data:",e);const n=[],a=new Set;e.tables&&Array.isArray(e.tables)&&e.tables.forEach(t=>{a.add(t.tableName),t.entries&&Array.isArray(t.entries)&&t.entries.forEach(t=>{n.push(t)})}),console.log("Processed data:",n.length,"entries"),updateTableFilter(Array.from(a)),allData=n,sortData(currentSort.column,!1),updateStats(),updateTable(),document.getElementById("last-update").textContent="Last updated: "+(new Date).toLocaleTimeString(),updateCompletionSummary()}else console.error("Failed to fetch cache data:",t.status,t.statusText);const e=await fetch("/api/status");if(e.ok){updateTaskPanel(await e.json()),updateTable()}}catch(t){console.error("Error fetching initial data:",t)}}function updateTableFilter(t){const e=document.getElementById("table-filter"),n=e.value;e.innerHTML='<option value="">All Tables</option>',t.sort().forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}),n&&t.includes(n)&&(e.value=n)}function updateStats(){const t=allData.length,e=allData.filter(t=>t.fileSize>0).length,n=allData.filter(t=>t.lastError).length;let a,s,o,l=null;const r="current"===statsMode&&archiverRunning&&currentTaskInfo&&currentTaskInfo.partitions_processed>0;if(r){const t=currentTaskInfo.partitions_processed||0,e=currentTaskInfo.table||"";l=[...allData.filter(t=>!e||t.table===e)].sort((t,e)=>(t.partition||"").localeCompare(e.partition||"")).slice(0,t),a=l.filter(t=>{if(!t.s3Uploaded||t.lastError||!t.fileSize||0===t.fileSize)return!1;if(t.fileTime&&archiverStartTime){return new Date(t.fileTime)>=archiverStartTime}return!1}).length,s=l.filter(t=>{if(t.lastError)return!1;if(t.s3Uploaded&&t.fileTime&&archiverStartTime){if(new Date(t.fileTime)<archiverStartTime)return!0}return!(!t.s3Uploaded||t.fileSize&&0!==t.fileSize)}).length,o=l.filter(t=>t.lastError).length}else a=allData.filter(t=>t.s3Uploaded&&!t.lastError).length,s=allData.filter(t=>!t.fileSize&&t.rowCount>0).length,o=allData.filter(t=>t.lastError).length;let i;if(r&&currentTaskInfo&&currentTaskInfo.total_partitions>0&&"number"==typeof currentTaskInfo.partitions_processed)i=currentTaskInfo.total_partitions-currentTaskInfo.partitions_processed;else if(r&&currentTaskInfo&&currentTaskInfo.total_items>0&&"number"==typeof currentTaskInfo.completed_items)i=currentTaskInfo.total_items-currentTaskInfo.completed_items;else{i=t-allData.filter(t=>t.rowCount>0||t.fileSize>0||t.lastError).length}(isNaN(i)||i<0)&&(i=0);const c=allData.reduce((t,e)=>t+(e.fileSize||0),0),d=allData.reduce((t,e)=>t+(e.uncompressedSize||0),0),u=allData.reduce((t,e)=>t+(e.rowCount||0),0),m=calculateRatio(d,c);let p=0;r&&currentTaskInfo&&currentTaskInfo.total_partitions>0&&"number"==typeof currentTaskInfo.partitions_processed?(p=currentTaskInfo.total_partitions-currentTaskInfo.partitions_processed,p<0&&(p=0)):p=allData.filter(t=>t.rowCount>0&&!t.fileSize&&!t.lastError&&!t.s3Uploaded).length;const g=a+s+p+o;let f=0;g>0&&(f=(a+s)/g*100);let v=allData;if(r){const t=currentTaskInfo.partitions_processed||0,e=currentTaskInfo.table||"";v=[...allData.filter(t=>!e||t.table===e)].sort((t,e)=>(t.partition||"").localeCompare(e.partition||"")).slice(0,t)}const y=v.map(t=>t.fileTime&&"0001-01-01T00:00:00Z"!==t.fileTime?new Date(t.fileTime):null).filter(t=>null!==t).sort((t,e)=>t-e);let h="N/A";if(y.length>0){const t=y[0],e=y[y.length-1];h=t.getTime()===e.getTime()?t.toLocaleDateString():t.toLocaleDateString()+" to "+e.toLocaleDateString()}let T="N/A";if(y.length>1){const t=v.filter(t=>r&&archiverStartTime?t.s3Uploaded&&t.fileSize>0&&t.fileTime&&new Date(t.fileTime)>=archiverStartTime:t.s3Uploaded&&t.fileSize>0),e=t.reduce((t,e)=>t+(e.rowCount||0),0);if(e>0){const n=t.map(t=>t.fileTime&&"0001-01-01T00:00:00Z"!==t.fileTime?new Date(t.fileTime):null).filter(t=>null!==t).sort((t,e)=>t-e);if(n.length>1){const t=(n[n.length-1]-n[0])/1e3;if(t>0){const n=e/t;T=formatNumber(Math.round(n))+" rows/sec"}}}}const S={partitions:t.toLocaleString(),size:formatBytes(c),ratio:m,rows:u.toLocaleString(),successRate:g>0?f.toFixed(1)+"%":"N/A",throughput:T,notSynced:i.toLocaleString(),partitionsDetail:e+" cached, "+n+" errors",sizeDetail:"Uncompressed: "+formatBytes(d),successRateDetail:a+" uploaded, "+s+" skipped, "+p+" pending, "+o+" failed",throughputDetail:h,notSyncedDetail:i>0?"Entries pending processing":"All processed"};if(lastStatsValues&&lastStatsValues.partitions===S.partitions&&lastStatsValues.size===S.size&&lastStatsValues.ratio===S.ratio&&lastStatsValues.rows===S.rows&&lastStatsValues.successRate===S.successRate&&lastStatsValues.throughput===S.throughput&&lastStatsValues.notSynced===S.notSynced&&lastStatsValues.successRateDetail===S.successRateDetail)return;lastStatsValues=S;const w=document.getElementById("stats-grid");if(w&&0!==w.children.length){const t=w.children,e=["Total Partitions","Total Size","Compression","Total Rows","Sync Rate","Throughput","Not Synced"],n=["","","Average ratio","Across all partitions","","",""];for(let a=0;a<Math.min(t.length,7);a++)t[a].querySelector(".label")||(t[a].innerHTML='<div class="label">'+e[a]+'</div><div class="value"></div><div class="detail">'+n[a]+"</div>")}else w.innerHTML='<div class="stat-card"><div class="label">Total Partitions</div><div class="value"></div><div class="detail"></div></div><div class="stat-card"><div class="label">Total Size</div><div class="value"></div><div class="detail"></div></div><div class="stat-card"><div class="label">Compression</div><div class="value"></div><div class="detail">Average ratio</div></div><div class="stat-card"><div class="label">Total Rows</div><div class="value"></div><div class="detail">Across all partitions</div></div><div class="stat-card"><div class="label">Sync Rate</div><div class="value"></div><div class="detail"></div></div><div class="stat-card"><div class="label">Throughput</div><div class="value"></div><div class="detail"></div></div><div class="stat-card"><div class="label">Not Synced</div><div class="value"></div><div class="detail"></div></div>';let b="success-rate-high";f<50?b="success-rate-low":f<90&&(b="success-rate-medium"),requestAnimationFrame(()=>{const t=w.children[0];if(t){const e=t.querySelector(".value"),n=t.querySelector(".detail");e&&e.textContent!==S.partitions&&(e.textContent=S.partitions,animateCell(e)),n&&n.textContent!==S.partitionsDetail&&(n.textContent=S.partitionsDetail)}const e=w.children[1];if(e){const t=e.querySelector(".value"),n=e.querySelector(".detail");t&&t.textContent!==S.size&&(t.textContent=S.size,animateCell(t)),n&&n.textContent!==S.sizeDetail&&(n.textContent=S.sizeDetail)}const n=w.children[2];if(n){const t=n.querySelector(".value");t&&t.textContent!==S.ratio&&(t.textContent=S.ratio,animateCell(t))}const a=w.children[3];if(a){const t=a.querySelector(".value");t&&t.textContent!==S.rows&&(t.textContent=S.rows,animateCell(t))}const s=w.children[4];if(s){const t=s.querySelector(".value"),e=s.querySelector(".detail");if(t){const e=S.successRate;t.textContent!==e?(t.textContent=e,t.className="value "+b,animateCell(t)):t.classList.contains(b)||(t.className="value "+b)}e&&e.textContent!==S.successRateDetail&&(e.textContent=S.successRateDetail)}const o=w.children[5];if(o){const t=o.querySelector(".value"),e=o.querySelector(".detail");t&&t.textContent!==S.throughput&&(t.textContent=S.throughput,animateCell(t)),e&&e.textContent!==S.throughputDetail&&(e.textContent=S.throughputDetail)}const l=w.children[6];if(l){const t=l.querySelector(".value"),e=l.querySelector(".detail");t&&t.textContent!==S.notSynced&&(t.textContent=S.notSynced,animateCell(t)),e&&e.textContent!==S.notSyncedDetail&&(e.textContent=S.notSyncedDetail)}})}function updateCompletionSummary(){const t=document.getElementById("completion-summary"),e=document.getElementById("summary-grid");if(0===allData.length)return void(t.style.display="none");if(archiverRunning)return void(t.style.display="none");if(!allData.some(t=>t.s3Uploaded||t.fileSize>0||t.lastError))return void(t.style.display="none");const n=allData.filter(t=>t.s3Uploaded&&!t.lastError).length,a=allData.filter(t=>!t.fileSize&&t.rowCount>0).length,s=allData.filter(t=>t.lastError).length,o=n+a+s,l=allData.reduce((t,e)=>t+(e.rowCount||0),0),r=allData.reduce((t,e)=>t+(e.fileSize||0),0),i=allData.reduce((t,e)=>t+(e.uncompressedSize||0),0);let c=0;o>0&&(c=n/o*100);let d="success-rate-high",u="#04B575";c<50?(d="success-rate-low",u="#FF4444"):c<90&&(d="success-rate-medium",u="#FFAA00");const m=allData.map(t=>t.fileTime&&"0001-01-01T00:00:00Z"!==t.fileTime?new Date(t.fileTime):null).filter(t=>null!==t).sort((t,e)=>t-e);let p="N/A";if(m.length>0){const t=m[0],e=m[m.length-1];p=t.getTime()===e.getTime()?t.toLocaleDateString():t.toLocaleDateString()+" to "+e.toLocaleDateString()}let g="N/A",f="N/A",v=0;if(m.length>1&&l>0){const t=(m[m.length-1]-m[0])/1e3;if(v=t,t>0){const e=l/t;if(g=formatNumber(Math.round(e))+" rows/sec",r>0){f=(r/1048576/t).toFixed(2)+" MB/sec"}}}let y="N/A";const h=allData.filter(t=>t.s3Uploaded&&!t.lastError&&t.fileSize>0);if(h.length>0){let t=0,e=0;if(h.forEach(n=>{const a=getProcessingTimeSeconds(n);a>0&&(t+=a,e++)}),e>0){y=formatDuration(t/e)}}const T={totalPartitions:allData.length,successful:n,skipped:a,failed:s,successRate:c.toFixed(1),totalRows:l,totalBytes:r,totalUncompressed:i,throughputRows:g,throughputMB:f,dateRange:p};lastSummaryValues&&lastSummaryValues.totalPartitions===T.totalPartitions&&lastSummaryValues.successful===T.successful&&lastSummaryValues.skipped===T.skipped&&lastSummaryValues.failed===T.failed&&lastSummaryValues.successRate===T.successRate&&lastSummaryValues.totalRows===T.totalRows&&lastSummaryValues.totalBytes===T.totalBytes||(lastSummaryValues=T,requestAnimationFrame(()=>{let m="";m+='<div class="summary-stat"><div class="summary-label">Total Partitions</div><div class="summary-value">'+allData.length.toLocaleString()+"</div></div>",m+='<div class="summary-stat summary-success"><div class="summary-label">✅ Uploaded</div><div class="summary-value">'+n.toLocaleString()+"</div></div>",a>0&&(m+='<div class="summary-stat summary-skip"><div class="summary-label">⏭ Skipped</div><div class="summary-value">'+a.toLocaleString()+"</div></div>"),s>0&&(m+='<div class="summary-stat summary-error"><div class="summary-label">❌ Failed</div><div class="summary-value">'+s.toLocaleString()+"</div></div>"),o>0&&(m+='<div class="summary-stat"><div class="summary-label">Success Rate</div><div class="summary-value '+d+'" style="color: '+u+'">'+c.toFixed(1)+"%</div></div>"),l>0&&(m+='<div class="summary-stat"><div class="summary-label">Total Rows Transferred</div><div class="summary-value">'+l.toLocaleString()+"</div></div>"),r>0&&(m+='<div class="summary-stat"><div class="summary-label">Total Data Uploaded</div><div class="summary-value">'+formatBytes(r)+'</div><div class="summary-detail">Uncompressed: '+formatBytes(i)+"</div></div>"),"N/A"!==g&&(m+='<div class="summary-stat"><div class="summary-label">Throughput</div><div class="summary-value">'+g+"</div>","N/A"!==f&&(m+='<div class="summary-detail">'+f+"</div>"),m+="</div>"),"N/A"!==p&&(m+='<div class="summary-stat"><div class="summary-label">Date Range</div><div class="summary-value">'+p+"</div></div>"),"N/A"!==y&&(m+='<div class="summary-stat"><div class="summary-label">Avg Time per Partition</div><div class="summary-value">'+y+"</div></div>"),v>0&&(m+='<div class="summary-stat"><div class="summary-label">Total Duration</div><div class="summary-value">'+formatDuration(v)+"</div></div>");const T=[],S=new Set,w=new Set,b=new Set;if(h.forEach(t=>{if(t.s3Key){const e=getOutputFormat(t.s3Key);e&&"—"!==e&&S.add(e);const n=getCompressionType(t.s3Key);n&&w.add(n);const a=getS3Bucket(t.s3Key);a&&b.add(a)}}),S.size>0){const t=Array.from(S).sort().join(", ");T.push("Format: "+t)}if(w.size>0){const t=Array.from(w).sort().join(", ");T.push("Compression: "+t)}if(b.size>0){const t=Array.from(b).sort().join(", ");T.push("S3: s3://"+t)}T.length>0&&(m+='<div class="summary-stat"><div class="summary-label">Configuration</div><div class="summary-value">'+T.join(" | ")+"</div></div>"),e.innerHTML=m,t.style.display="block"}))}function sortData(t,e=!0){e&&currentSort.column===t?currentSort.direction="asc"===currentSort.direction?"desc":"asc":e&&(currentSort.column=t,currentSort.direction="asc"),allData.sort((e,n)=>{let a=e[t],s=n[t];return"processingTime"===t?(a=getProcessingTimeSeconds(e),s=getProcessingTimeSeconds(n)):"fileTime"===t||"countTime"===t||"errorTime"===t?(a=a?new Date(a).getTime():0,s=s?new Date(s).getTime():0):"string"==typeof a?(a=(a||"").toLowerCase(),s=(s||"").toLowerCase()):(a=a||0,s=s||0),a<s?"asc"===currentSort.direction?-1:1:a>s?"asc"===currentSort.direction?1:-1:0}),updateTable(),updateSortIndicators()}function updateSortIndicators(){document.querySelectorAll("thead th.sortable").forEach(t=>{t.className="sortable",t.dataset.column===currentSort.column?(t.className="sortable sorted-"+currentSort.direction,t.setAttribute("aria-sort","asc"===currentSort.direction?"ascending":"descending"),announceToScreenReader("Column "+t.textContent.trim()+" sorted "+("asc"===currentSort.direction?"ascending":"descending"))):t.setAttribute("aria-sort","none")})}function getEntryStatus(t){return archiverRunning&&currentPartition&&t.partition===currentPartition&&t.table===(currentTaskInfo?.table||"")?"processing":t.lastError?"error":t.s3Uploaded&&!t.lastError?"uploaded":t.fileSize>0&&!t.s3Uploaded&&!t.lastError?"not-synced":t.rowCount>0&&!t.fileSize&&!t.lastError?"skipped":t.rowCount&&0!==t.rowCount?"unknown":"pending"}function updateTable(){const t=document.getElementById("search-box").value,e=document.getElementById("table-filter").value,n=document.getElementById("status-filter").value;let a=allData;if(e&&(a=a.filter(t=>t.table===e)),n&&(a=a.filter(t=>getEntryStatus(t)===n)),t){const e=t.toLowerCase();a=a.filter(t=>t.partition.toLowerCase().includes(e)||t.table.toLowerCase().includes(e))}const s=document.getElementById("table-body");if(0===a.length&&(t||e||n))return s.innerHTML='<tr><td colspan="11" style="text-align: center; padding: 60px 20px;"><div class="empty-state"><h3>No Results Found</h3><p>No cache entries match your filters. Try adjusting your search or filter.</p><button class="clear-search-btn" id="clear-filters-btn">Clear Filters</button></div></td></tr>',void document.getElementById("clear-filters-btn")?.addEventListener("click",()=>{document.getElementById("search-box").value="",document.getElementById("table-filter").value="",document.getElementById("status-filter").value="",updateTable()});if(0===a.length&&0===allData.length)return void(s.innerHTML='<tr><td colspan="11" style="text-align: center; padding: 60px 20px;"><div class="empty-state"><h3>No Cache Data</h3><p>No cache entries found. The archiver will populate this table as it processes partitions.</p></div></td></tr>');const o={},l=new Set;s.querySelectorAll("tr").forEach(t=>{o[t.dataset.key]=t}),requestAnimationFrame(()=>{a.forEach(t=>{const e=getRowKey(t),n=o[e];n&&(updateRow(n,t),l.add(e))}),s.querySelectorAll("tr").forEach(t=>{const e=t.dataset.key;l.has(e)||t.querySelector(".empty-state")||t.remove()}),a.forEach(t=>{const e=getRowKey(t);if(!o[e]){const e=createRow(t);s.appendChild(e)}});const t=Array.from(s.querySelectorAll("tr")).map(t=>t.dataset.key),e=a.map(t=>getRowKey(t));if(!(t.length===e.length&&t.every((t,n)=>t===e[n]))&&t.length>0){const t={};s.querySelectorAll("tr").forEach(e=>{t[e.dataset.key]=e}),s.innerHTML="",e.forEach(e=>{t[e]&&s.appendChild(t[e])})}})}function createRow(t){const e=document.createElement("tr");return e.dataset.key=getRowKey(t),e.setAttribute("role","row"),e.setAttribute("aria-label","Partition "+t.partition+" in table "+t.table),updateRow(e,t),e}function updateRow(t,e){const n=calculateCompletionAge(e),a=calculateProcessingTime(e),s=e.fileSize>0,o=!!e.lastError,l=e.s3Uploaded,r=calculateRatio(e.uncompressedSize,e.fileSize),i=archiverRunning&&currentPartition&&e.partition===currentPartition&&e.table===(currentTaskInfo?.table||"");let c="";c=i?'<span class="status-badge processing">Processing</span>':o?'<span class="status-badge error">Error</span>':l?'<span class="status-badge uploaded">In S3</span>':s?'<span class="status-badge cached">Processed</span>':'<span class="status-badge no-file">Count Only</span>',i?t.classList.add("processing-row"):t.classList.remove("processing-row");const d=t.querySelectorAll("td"),u=0===d.length;let m="—";if(e.fileMD5){m='<span title="'+escapeHTMLAttr(e.fileMD5+(e.multipartETag?" (multipart: "+e.multipartETag+")":""))+'">'+escapeHTML(e.fileMD5.substring(0,12))+"..."+(e.multipartETag?' <span class="multipart-tag" title="Multipart ETag: '+escapeHTMLAttr(e.multipartETag)+'">[MP]</span>':"")+"</span>"}else e.multipartETag&&(m='<span class="multipart-tag" title="Multipart ETag: '+escapeHTMLAttr(e.multipartETag)+'">'+escapeHTML(e.multipartETag)+"</span>");if(u){const s=getOutputFormat(e.s3Key);t.innerHTML='<td><div class="partition-name">'+escapeHTML(e.partition)+'</div><div class="table-name">'+escapeHTML(e.table)+'</div></td><td class="size">'+(null!=e.rowCount?e.rowCount.toLocaleString():"—")+'</td><td class="format">'+s+'</td><td class="size">'+formatBytes(e.uncompressedSize)+'</td><td class="size">'+formatBytes(e.fileSize)+'</td><td class="ratio">'+r+'</td><td class="hash">'+m+'</td><td><span class="age '+n.class+'">'+n.text+'</span></td><td class="processing-time">'+a+"</td><td>"+c+"</td><td>"+(o?'<div class="error-text" title="'+escapeHTMLAttr(e.lastError)+'">'+escapeHTML(e.lastError)+"</div>":"—")+"</td>"}else{const t=null!=e.rowCount?e.rowCount.toLocaleString():"—",s=getOutputFormat(e.s3Key),l=formatBytes(e.uncompressedSize),i=formatBytes(e.fileSize),u=d[1];if(u){const e=u.textContent;e!==t&&(u.textContent=t,e&&"—"!==e&&animateCell(u))}const p=d[2];if(p){p.textContent!==s&&(p.textContent=s)}const g=d[3];if(g){const t=g.textContent;t!==l&&(g.textContent=l,t&&"—"!==t&&animateCell(g))}const f=d[4];if(f){const t=f.textContent;t!==i&&(f.textContent=i,t&&"—"!==t&&animateCell(f))}const v=d[5];v&&v.textContent!==r&&(v.textContent=r);const y=d[6];y&&y.innerHTML!==m&&(y.innerHTML=m);const h=d[7];if(h){const t='<span class="age '+n.class+'">'+n.text+"</span>";h.innerHTML!==t&&(h.innerHTML=t)}const T=d[8];T&&T.textContent!==a&&(T.textContent=a);const S=d[9];S&&S.innerHTML!==c&&(S.innerHTML=c);const w=d[10];if(w){const t=o?'<div class="error-text" title="'+escapeHTMLAttr(e.lastError)+'">'+escapeHTML(e.lastError)+"</div>":"—";w.innerHTML!==t&&(w.innerHTML=t)}}}function animateCell(t){t&&(t.classList.remove("updated"),t.offsetWidth,t.classList.add("updated"),setTimeout(()=>t.classList.remove("updated"),800))}const searchBox=document.getElementById("search-box"),clearBtn=document.getElementById("clear-search");function openLogsModal(){const t=document.getElementById("logs-modal");t.style.display="flex",t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",logsWebSocket&&logsWebSocket.readyState===WebSocket.OPEN||connectLogsWebSocket();const e=document.getElementById("logs-container");setTimeout(()=>{e.scrollTop=e.scrollHeight},100)}function closeLogsModal(){const t=document.getElementById("logs-modal");t.style.display="none",t.setAttribute("aria-hidden","true"),document.body.style.overflow="",logsWebSocket&&(logsWebSocket.close(),logsWebSocket=null),logsPaused=!1,logsBuffer=[];const e=document.getElementById("logs-pause");e&&(e.textContent="Pause",e.classList.remove("paused"))}function connectLogsWebSocket(){logsWebSocket&&logsWebSocket.close();const t=("https:"===window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/ws/logs";logsWebSocket=new WebSocket(t),logsWebSocket.onopen=function(){console.log("Logs WebSocket connected")},logsWebSocket.onmessage=function(t){console.log("Logs WebSocket message received:",t.data),logsPaused?(logsBuffer.push(JSON.parse(t.data)),logsBuffer.length>maxLogEntries&&logsBuffer.shift()):handleLogMessage(JSON.parse(t.data))},logsWebSocket.onerror=function(t){console.error("Logs WebSocket error:",t)},logsWebSocket.onclose=function(){console.log("Logs WebSocket disconnected"),setTimeout(()=>{const t=document.getElementById("logs-modal");t&&"none"!==t.style.display&&connectLogsWebSocket()},3e3)}}function handleLogMessage(t){console.log("handleLogMessage called with:",t);const e=document.getElementById("logs-container");if(!e)return void console.error("logs-container not found!");const n=document.createElement("div");n.className="log-entry "+(t.level||"info").toLowerCase();const a=t.timestamp||"",s=t.level||"INFO",o=t.message||"";n.innerHTML='<span class="log-timestamp">'+escapeHTML(a)+'</span><span class="log-level">'+escapeHTML(s)+'</span><span class="log-message">'+escapeHTML(o)+"</span>",e.appendChild(n);const l=e.querySelectorAll(".log-entry");l.length>maxLogEntries&&l[0].remove();e.scrollHeight-e.scrollTop-e.clientHeight<100&&(e.scrollTop=e.scrollHeight)}function clearLogs(){const t=document.getElementById("logs-container");t&&(t.innerHTML="",logsBuffer=[])}function toggleLogsPause(){logsPaused=!logsPaused;const t=document.getElementById("logs-pause");t&&(t.textContent=logsPaused?"Resume":"Pause",t.classList.toggle("paused",logsPaused)),!logsPaused&&logsBuffer.length>0&&(logsBuffer.forEach(t=>{handleLogMessage(t)}),logsBuffer=[])}function scrollToCurrentPartition(){if(!followActive||!archiverRunning||!currentPartition)return;const t=document.querySelectorAll("#table-body tr");for(const e of t){const t=e.querySelector("td:first-child .partition-name"),n=e.querySelector("td:first-child .table-name");if(t&&t.textContent.trim()===currentPartition){const t=currentTaskInfo?.table||"";if(t&&n&&n.textContent.trim()!==t)continue;e.scrollIntoView({behavior:"smooth",block:"center"});const a=document.querySelector(".table-wrapper");if(a){const t=e.offsetTop,n=e.offsetHeight,s=a.scrollTop,o=a.offsetHeight;(t<s||t+n>s+o)&&(a.scrollTop=t-o/2+n/2)}break}}}function toggleFollow(){followActive=!followActive;const t=document.getElementById("follow-button"),e=(document.getElementById("follow-icon"),document.getElementById("follow-text"));t&&(t.classList.toggle("active",followActive),e.textContent=followActive?"Following":"Follow"),followActive?(scrollToCurrentPartition(),followInterval&&clearInterval(followInterval),followInterval=setInterval(()=>{scrollToCurrentPartition()},500)):followInterval&&(clearInterval(followInterval),followInterval=null)}searchBox.addEventListener("input",t=>{const e=t.target.value;clearBtn.style.display=e?"flex":"none",updateTable()}),clearBtn.addEventListener("click",()=>{searchBox.value="",clearBtn.style.display="none",updateTable(),searchBox.focus(),announceToScreenReader("Search cleared")}),document.getElementById("table-filter").addEventListener("change",updateTable),document.getElementById("status-filter").addEventListener("change",updateTable),document.getElementById("stats-mode-toggle").addEventListener("change",function(t){statsMode=t.target.value,updateStats()}),document.getElementById("follow-button").addEventListener("click",toggleFollow),document.addEventListener("click",t=>{const e=t.target.closest("th.sortable");e&&sortData(e.dataset.column)}),document.addEventListener("keydown",t=>{const e=t.target.closest("th.sortable");!e||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),sortData(e.dataset.column))}),document.addEventListener("click",t=>{const e=t.target.closest(".partition-link");if(e){t.preventDefault();const n=e.dataset.partition;n&&scrollToPartition(n)}}),fetchInitialData(),updateSortIndicators(),connectWebSocket(),setInterval(()=>{if(allData.length>0){const t=document.getElementById("table-body");if(t){t.querySelectorAll("tr").forEach(t=>{const e=t.dataset.key;if(e){const[n,a]=e.split("|"),s=allData.find(t=>t.table===n&&t.partition===a);if(s){const e=t.querySelectorAll("td")[7];if(e){const t=calculateCompletionAge(s),n='<span class="age '+t.class+'">'+t.text+"</span>";e.innerHTML=n}}}})}}},6e4),document.getElementById("logs-button").addEventListener("click",openLogsModal),document.getElementById("logs-modal-close").addEventListener("click",closeLogsModal),document.getElementById("logs-modal-overlay").addEventListener("click",closeLogsModal),document.getElementById("logs-clear").addEventListener("click",clearLogs),document.getElementById("logs-pause").addEventListener("click",toggleLogsPause),document.addEventListener("keydown",function(t){if("Escape"===t.key){const t=document.getElementById("logs-modal");t&&"none"!==t.style.display&&closeLogsModal()}}),window.scrollToPartition=function(t){setTimeout(()=>{const e=document.querySelectorAll("#table-body tr");for(const n of e){const e=n.querySelector("td:first-child .partition-name");if(e&&e.textContent.trim()===t){const t=n.style.background;n.style.background="var(--color-warning-50)",n.scrollIntoView({behavior:"smooth",block:"center"});const e=document.querySelector(".table-wrapper");if(e){const t=n.offsetTop,a=n.offsetHeight,s=e.scrollTop,o=e.offsetHeight;(t<s||t+a>s+o)&&(e.scrollTop=t-o/2+a/2)}setTimeout(()=>{n.style.background=t||""},2e3);break}}},100)},window.addEventListener("beforeunload",()=>{ws&&ws.close(),wsReconnectInterval&&clearTimeout(wsReconnectInterval),followInterval&&clearInterval(followInterval),logsWebSocket&&logsWebSocket.close()});